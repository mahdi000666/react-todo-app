pipeline {
    agent any
    
    environment {
        // --- CONST-CORRECTNESS & EFFICIENCY ---
        // 1. Define the commit SHA once
        COMMIT_SHA = env.GIT_COMMIT.take(7)
        
        // 2. DYNAMIC PORT: Base port 8080 + Build Number (prevents port allocation conflicts for concurrent builds)
        PORT = 8080 + Integer.parseInt(env.BUILD_NUMBER)
        
        // 3. Define clean, consistent image and container names
        IMAGE_TAG_18 = "react-dev-node18:${COMMIT_SHA}"
        IMAGE_TAG_20 = "react-dev-node20:${COMMIT_SHA}"
        CONTAINER_NAME = "react-dev-container-${env.BUILD_NUMBER}"
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }
        
        stage('Setup') {
            steps {
                bat 'npm ci --prefer-offline'
            }
        }
        
        // NEW STAGE: Defensive Cleanup for Images (prevents "image already exists" error)
        stage('Cleanup Images') {
            steps {
                echo "Cleaning up previous image tags to prevent conflicts."
                // '|| exit 0' ensures the pipeline continues if images don't exist
                bat "docker rmi ${env.IMAGE_TAG_18} 2>nul || exit 0"
                bat "docker rmi ${env.IMAGE_TAG_20} 2>nul || exit 0"
            }
        }
        
        stage('Build (parallel)') {
            parallel {
                stage('Build Node18') {
                    steps {
                        // Use defined const variable
                        bat "docker build --no-cache --build-arg NODE_VERSION=18 -t ${env.IMAGE_TAG_18} ."
                    }
                }
                stage('Build Node20') {
                    steps {
                        // Use defined const variable
                        bat "docker build --no-cache --build-arg NODE_VERSION=20 -t ${env.IMAGE_TAG_20} ."
                    }
                }
            }
        }
        
        stage('Run Docker') {
            steps {
                script {
                    // Cleanup previous run container using dynamic name
                    bat "docker stop ${env.CONTAINER_NAME} 2>nul || exit 0"
                    bat "docker rm ${env.CONTAINER_NAME} 2>nul || exit 0"
                    
                    // Deploy using the DYNAMIC PORT and unique CONTAINER_NAME
                    bat "docker run -d -p ${env.PORT}:80 --name ${env.CONTAINER_NAME} ${env.IMAGE_TAG_20}"
                    bat 'timeout /t 5 /nobreak'
                }
            }
        }
        
        stage('Smoke Test') {
            steps {
                // *** FIX: Pass the dynamic port number to smoke-test.bat ***
                bat "call smoke-test.bat ${env.PORT}"
                archiveArtifacts artifacts: 'smoke.log', allowEmptyArchive: true
            }
        }
        
        stage('Archive Artifacts') {
            steps {
                bat 'echo Build completed > build.log'
                archiveArtifacts artifacts: 'dist/**,build.log,smoke.log', allowEmptyArchive: true
            }
        }
        
        stage('Cleanup') {
            steps {
                // Ensure cleanup uses the unique container name
                bat "docker stop ${env.CONTAINER_NAME} 2>nul || exit 0"
                bat "docker rm ${env.CONTAINER_NAME} 2>nul || exit 0"
            }
        }
    }
    
    post {
        always {
            // Final defensive cleanup using the unique container name
            bat "docker stop ${env.CONTAINER_NAME} 2>nul || exit 0"
            bat "docker rm ${env.CONTAINER_NAME} 2>nul || exit 0"
        }
        failure {
            echo "✗ Pipeline failed on branch dev"
        }
        success {
            echo "✓ Pipeline completed successfully on branch dev"
        }
    }
}