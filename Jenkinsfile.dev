pipeline {
    agent any
    triggers { pollSCM('H/2 * * * *') } // optional: webhook preferred
    stages {
        stage('Checkout') { steps { checkout scm } }
        stage('Setup') { steps { bat 'npm ci' } }
        stage('Build (parallel)') {
            parallel {
                stage('Build Node18') {
                    steps {
                        bat 'docker build --build-arg NODE_VERSION=18 -t react-dev-node18:%GIT_COMMIT% .'
                    }
                }
                stage('Build Node20') {
                    steps {
                        bat 'docker build --build-arg NODE_VERSION=20 -t react-dev-node20:%GIT_COMMIT% .'
                    }
                }
            }
        }
        stage('Run Docker') {
            steps {
                bat 'docker run -d -p 8080:80 --name react_dev_%BUILD_NUMBER% react-dev-node20:%GIT_COMMIT%'
            }
        }
        stage('Smoke Test') {
            steps {
                bat 'call smoke-test.bat > smoke.log || (type smoke.log & exit /b 1)'
                archiveArtifacts artifacts: 'smoke.log', allowEmptyArchive: true
            }
        }
        stage('Archive Artifacts') {
            steps {
                archiveArtifacts artifacts: 'dist/**, build.log', allowEmptyArchive: true
            }
        }
        stage('Cleanup') {
            steps {
                bat """
                for /F "tokens=*" %%i in ('docker ps -a --filter "name=react_dev_%BUILD_NUMBER%" --format "{{.ID}}"') do docker rm -f %%i
                """
            }
        }
    }
}
